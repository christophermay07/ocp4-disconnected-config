<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>DCGS Openshift</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">DCGS Openshift</h1>
</header>
<p><img src="./docs/images/Red_Hat_Logo_2019.png" width="200"/></p>
<h1 id="openshift-4-disconnected-collection">Openshift 4 Disconnected
Collection</h1>
<h2 id="overview">Overview</h2>
<h3 id="the-why">The why</h3>
<ul>
<li>The goal of this repository is to provide a standardized workflow
for deploying OpenShift 4 in a disconnected environment using an
agent-based installer.</li>
</ul>
<h3 id="the-how">The how</h3>
<ul>
<li>The idea is to have all variables set in group_vars/all, with some
defaults set in roles. The defaults in roles are only applied in case
they are not set in group_vars.</li>
</ul>
<h4 id="variables">Variables</h4>
<ul>
<li><p>cluster_version: This variable controls the version of the
cluster and allows for the pulling of operators and additional images
(for the cluster) via oc-mirror. This requires an active subscription
with a pull secret in ~/.docker/config.json. It will pull all the
required binaries along with some additional nice-to-haves (such as
Butane).</p></li>
<li><p>cluster_deployment: This variable controls how the cluster is
deployed. It will generate the install-config and agent-config based on
configured variables.</p></li>
<li><p>static this is used to set things that very rarely change or set
variables defined in other vars, that are built ontop of other
variables</p></li>
</ul>
<h4 id="some-assumptions-include">Some assumptions include:</h4>
<ul>
<li>SSH keys will not exist.</li>
<li>SSL certificates for the hosted registry will be generated, which
will run on the disconnected host. Post-Install Configuration</li>
</ul>
<h4 id="goals">Goals</h4>
<ul>
<li><p>The current goal for post-install configuration is to deploy
ArgoCD and have it manage the configuration and enforcement.</p></li>
<li><p>To assist with this, a local Git repository will be configured as
described in this <a
href="https://thenewstack.io/create-a-local-git-repository-on-linux-with-the-help-of-ssh/">article.</a></p></li>
</ul>
<h4 id="status">Status</h4>
<ul>
<li>This is a work in progress, and we will continue to make
enhancements over time.</li>
</ul>
<h4 id="requirements-disconnected-system">Requirements (disconnected
system)</h4>
<ul>
<li>Packages:
<ul>
<li>nmstate</li>
<li>openssl</li>
<li>httpd-tools</li>
</ul></li>
<li>Ansible-collections
<ul>
<li>dellemc.openmanage</li>
</ul></li>
</ul>
<h2 id="additional-info">Additional Info:</h2>
<p><a href="/docs/vm-migration-notes.adoc">View notes on recommended
procedures for vm migrations</a></p>
<p>This file was generated with the following command:</p>
<ul>
<li>pandoc ./README.md ./Install.md ./helm/openshift-gitops/README.md
./helm/openshift-gitops-day2/README.md ./docs/vm-migration-notes.md -f
markdown -t html -s –metadata title=“DCGS Openshift” -o
openshift-dcgs-installation.html</li>
</ul>
<h2 id="thanks">Thanks:</h2>
<p>This started as as a fork from <a
href="https://github.com/hyperkineticnerd/ansible-ocp4-agent">hyperkineticnerd/ansible-ocp4-agent</a>,
but we have since diverged quite a bit away, but still would like to
give credit.</p>
<h1 id="red-hat-openshift-installation-guide">Red Hat OpenShift
Installation Guide</h1>
<p><img src="./docs/images/ocplogo.jpg" width="200"/></p>
<p>This guide covers the process for installing Red Hat OpenShift 4.15+
on Red Hat Enterprise Linux 9 with options for FIPS and STIG
configurations. The instructions support deployment on both connected
and disconnected environments.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li><p><strong>RHEL 9 Installation</strong>: Install Red Hat Enterprise
Linux 9 and register it with your Red Hat account.</p>
<blockquote>
<p><strong>NOTE:</strong> If The goal is to have a fips enabled cluster,
the bastion host also has to FIPS aswell. If you dont need fips, you can
ignore the following configurations.</p>
</blockquote></li>
<li><p><strong>Environment Configurations</strong>:</p>
<blockquote>
<p><strong>NOTE:</strong> These configurations can be done post install.
Changes to usbguard/sysctl.conf will require a reboot, while fapolicyd
will only require restart on the service.</p>
</blockquote>
<ol type="1">
<li><p>Ensure <strong>FIPS</strong> mode is enabled for RHEL 9.</p>
<ul>
<li><a
href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/security_hardening/switching-rhel-to-fips-mode_security-hardening#proc_installing-the-system-with-fips-mode-enabled_switching-rhel-to-fips-mode">Enable
FIPS during installation</a>; or</li>
<li><a
href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/security_hardening/switching-rhel-to-fips-mode_security-hardening#switching-the-system-to-fips-mode_using-the-system-wide-cryptographic-policies">Enable
FIPS post-installation</a></li>
</ul></li>
<li><p>Configure <strong>STIG</strong> compliance as needed</p></li>
<li><p>Configure <strong>fapolicyd</strong> for Ansible Playbooks:</p>
<ul>
<li><p>Allow regular users to run Ansible playbooks by creating a new
file at <code>/etc/fapolicyd/rules.d/22-ansible.rules</code> with the
following contents:</p>
<pre class="plaintext"><code>allow perm=any uid=1000 : dir=/home/user/.ansible
allow perm=any uid=1000 : dir=/home/user/.cache/agent
allow perm=any uid=1000 : dir=/usr/share/git-core/templates/hooks
allow perm=any uid=1000 : dir=/pods
allow perm=any uid=1000 : dir=/usr/bin
allow perm=any uid=0,1000 : dir=/tmp</code></pre></li>
</ul></li>
<li><p>Adjust User Namespace Limits for Registry Pod:</p>
<ul>
<li>Increase the <code>user.max_user_namespaces</code> setting to enable
the registry pod to run as a non-root user. Update
<code>/etc/sysctl.conf</code> as follows:
<code>plaintext  # Per CCE-83956-3: Set user.max_user_namespaces = 0 in /etc/sysctl.conf  user.max_user_namespaces = 5</code></li>
</ul></li>
<li><p>Enable Access to External USB Devices (for Disconnected
Environments):</p>
<ul>
<li><p>Add the following commands to the <code>%post</code> section in
your kickstart file:</p>
<pre class="plaintext"><code>systemctl disable usbguard
sed -i &#39;s/black/\#black/g&#39; /etc/modprobe.d/usb-storage.conf
sed -i &#39;s/install/\#install/g&#39; /etc/modprobe.d/usb-storage.conf</code></pre></li>
</ul></li>
<li><p>Install Ansible/Podman:
<code>shell     sudo dnf install ansible-core     sudo dnf install container-tools</code></p>
<p>to verify they are installed correctly you can run:
<code>shell  ansible --version  podman -v</code></p></li>
<li><p>Clone the Repository:
<code>shell     git clone https://github.com/cjnovak98/ocp4-disconnected-config</code></p></li>
<li><p>Navigate to the Playbooks Directory:
<code>shell     cd ocp4-disconnected-config/playbooks</code></p></li>
<li><p>Install Required Ansible Collections:
<code>shell     ansible-playbook ansible-galaxy.yml</code> —</p></li>
</ol></li>
</ul>
<h2 id="running-the-automation">Running the Automation</h2>
<h3 id="directory-structure-assumptions">Directory Structure
Assumptions</h3>
<ul>
<li><strong>Content Path</strong>: Ensure that the content resides in
<code>/pods/content</code> (definable in
<code>playbooks/group_vars/all/cluster-deployment.yml</code>). It is
assumed this is the transferable media when running connected side for a
disconnected cluster and disconnected config is
/pods/content/ansible</li>
</ul>
<h3 id="update-environment-variables">Update Environment Variables</h3>
<ul>
<li>Modify <code>group_vars/all/cluster-deployment.yml</code> to
customize it for your environment. Key variables include:
<ul>
<li><code>common_openshift_dir</code>: Directory for pulled content to
live.</li>
<li><code>common_connected_cluster</code>: Set to <code>true</code> if
the cluster itself is connected.</li>
<li><code>mirror_content_pull_mirror</code>: Set to <code>true</code> to
pull content (set to <code>false</code> for disconnected
environments).</li>
<li><code>common_fips_enabled</code>: <code>true</code> if the host is
stigged and FIPS is enabled.</li>
<li><code>common_cluster_domain</code>: Top-Level Domain (TLD) for the
cluster.</li>
<li><code>common_ip_space</code>: First three octets of the IP address
range for both the bastion and cluster.</li>
<li><code>common_nodes</code>: Details of nodes, including name, last
octet of the node IP, and MAC addresses.</li>
<li><code>idracs_user</code> and <code>idracs_password</code>: iDRAC
credentials.</li>
<li><code>idracs</code>: Node name and IP of the node’s iDRAC.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example playbooks/group_vars/all/cluster-deployment.yml</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">common_git_repos</span><span class="kw">:</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;https://github.com/cjnovak98/ocp4-disconnected-collection.git&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;https://github.com/cjnovak98/ocp4-disconnected-config&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">common_openshift_dir</span><span class="kw">:</span><span class="at"> /pods/content</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">common_connected_cluster</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mirror_content_pull_mirror</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">common_openshift_interface</span><span class="kw">:</span><span class="at"> ens1</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">common_fips_enabled</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">common_cluster_domain</span><span class="kw">:</span><span class="at"> example.com</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">common_ip_space</span><span class="kw">:</span><span class="at"> </span><span class="fl">192.168.122</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="fu">common_nodes</span><span class="kw">:</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> master-0</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ip</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;42&#39;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">mac</span><span class="kw">:</span><span class="at"> 52:54:00:8d:13:77</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> worker-0</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ip</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;43&#39;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">mac</span><span class="kw">:</span><span class="at"> 52:54:00:8d:13:78</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># iDRAC</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">#idrac_user: test</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">#idrac_password: tester</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">#media_share_idracs:</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">#  - name: master-0</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">#    ip: &#39;{{ ip_space }}.5&#39;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">#  - name: master-1</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">#    ip: &#39;{{ ip_space }}.6&#39;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co">#  - name: master-2</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">#    ip: &#39;{{ ip_space }}.7&#39;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co">#  - name: worker-0</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">#    ip: &#39;{{ ip_space }}.8&#39;</span></span></code></pre></div>
<h3
id="run-content-gathering-playbook-to-prepare-disconnected-environments">Run
Content Gathering Playbook to Prepare Disconnected Environments:</h3>
<h4 id="ensure-a-valid-pull-secret-exists">Ensure A Valid Pull-Secret
Exists:</h4>
<p>You can get your pull secret from <a
href="https://console.redhat.com/openshift/create/local">https://console.redhat.com/openshift/create/local</a>
and store it in <code>~/.docker/config</code> of the host where you’re
running the automation.</p>
<blockquote>
<p>NOTE: If the pull-secret is absent, it will cause the automation to
fail but you can simply add it and rerun the playbook.</p>
</blockquote>
<h4 id="run-the-gather-content-playbook">Run the Gather Content
Playbook:</h4>
<p>If you are deploying on a disconnected system then you will first
need to gather all of the openshift content on a machine that has
internet connection and transfer it over. There is a playbook that you
can run which will gather the appropriate content:</p>
<pre class="shell"><code>ansible-playbook -K gather-content.yml</code></pre>
<p>or</p>
<pre class="shell"><code>./gather-content.yml</code></pre>
<p>Once you have the content downloaded, transfer it to your
disconnected machine and put in the content directory
(i.e. /pods/content)</p>
<p>It is recommended to use the target directory
(<code>common_openshift_dir</code>) on a mounted hard drive. This
approach allows all downloaded content to be stored directly on the
drive, which can then be unmounted and physically transferred to the
disconnected system. If this isn’t feasible, you would need to transfer
the content manually using tools like <code>cp</code> or
<code>rsync</code>.</p>
<h3 id="run-the-deployment-playbook">Run the Deployment Playbook:</h3>
<p>For both connected and disconnected clusters, deploy the cluster by
running:</p>
<pre class="shell"><code>ansible-playbook -K deploy-cluster.yml</code></pre>
<p>or</p>
<pre class="shell"><code>./deploy-cluster.yml</code></pre>
<blockquote>
<p><strong>NOTE:</strong> For disconnected clusters, ensure the drive is
mounted from the internet-connected machine and update
<code>group_vars/all/cluster-deployment.yml</code> with its mount point.
This configuration is critical for success, as the process will fail
without it. You don’t need to worry about manually handling the
pull-secret; one will be generated automatically based on the settings
in <code>group_vars/all/cluster-deployment.yml</code>.</p>
</blockquote>
<h1 id="ocp-gitops-day-1">OCP GitOps Day 1</h1>
<p>This helm chart is in charge of some basic setup after the initial
deployment of OpenShft.</p>
<p>The idea behind this is that without OpenShift Git Ops, working with
an easily observable and maintainable infrastructure as code setup
becomes hard. This template essentially just sets up that GitOps
installation to where is is useful for the next, day 2, steps where the
bulk of the cluster configuration is performed.</p>
<h2 id="usage">Usage</h2>
<p>To apply this template to your cluster, simply run the helm install
command:</p>
<p><code>helm install gitops-day1 . --values=./your/values.yaml</code></p>
<p>This applies the yaml to the cluster, and will perform the day 1
operations. Note that it might take a few minutes for everything to come
up and be ready, so be patient. You can tell the installation has
finished and was successful by navigating to ArgoCD (top right apps menu
in OCP web ui -&gt; ArgoCD), logging in via OpenShift, and seeing the
blank ArgoCD page. From there, you can verify the git repository was
successfully added by navigating to Settings (on the left) -&gt;
Repositories. You should see your gitOps git repo in the list, with a
green checkmark indicating success.</p>
<p>You can also use the following command to output the finished product
without actually applying it to OpenShift, in order to debug and
check:</p>
<p><code>helm template test . --debug | less</code></p>
<h3 id="values">Values</h3>
<p>In order to properly run this chart, you will need to create your own
values file specifying the values relevant to your setup.</p>
<p>This can be built by copying the existing <a
href="values.yaml">values.yaml</a>, and adjusting accordingly.</p>
<p>Mainly, you will need the IP of the system you ran the Ansible from,
which is where resources are hosted for the disconnected install, as
well as for continued GitOps work. You will also need the ssh private
key of the user that was used to run the Ansible, as that is in turn
used to access the Git repository for the aforementioned GitOps.</p>
<h1 id="ocp-4-disconnected-config-day2-helm-chart">OCP 4 Disconnected
Config Day2 Helm Chart</h1>
<p>This chart applies the cluster settings and resources necessary for
day to day operations in the target environment. It is intended to be
deployed via OpenShift GitOps as part of a infrastructure as code
process.</p>
<p>In this case, comments have been provided in both the default
<code>values.yaml</code> and each of the <code>.yaml</code> files in the
<code>templates/</code> directory to help explain each component.</p>
<h2 id="deployment">Deployment</h2>
<p>To use, you will simply add an application in Argo, and supply this
repo/directory, as well as the values file customized for your
environment:</p>
<ul>
<li>Application Name: cluster-day2</li>
<li>Project Name: default</li>
<li>Sync Policy: Automatic</li>
<li>Source:
<ul>
<li>Repository URL: Select the ocp4-disconnected-config repo running on
the bastion host</li>
<li>Revision: HEAD (or override to your desired branch)</li>
<li>Path: ./helm/openshift-gitops-day2</li>
</ul></li>
<li>Destination:
<ul>
<li>Cluster URL: https://kubernetes.default.svc # Use this value to
target the same cluster that Argo is running on.</li>
<li>Namespace: leave blank or set to default if required</li>
</ul></li>
<li>Values:
<ul>
<li>Override the values as needed. If Argo was able to successfully
connect to the source repo configuration, then you should see a list of
optional values to override. You can also upload your own
<code>values.yaml</code> file.</li>
</ul></li>
</ul>
<p>To get to Argo, simply select it from the top right dropdown on the
OpenShift web ui.</p>
<p>You can also use the following command to see what will be applied
before actually applying:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">helm</span> template test . <span class="at">--debug</span> <span class="kw">|</span> <span class="fu">less</span></span></code></pre></div>
<p>The default <a href="values.yaml">values.yaml</a> is designed to be
give you the basic layout, as well as provide a template for your own
custom values file. Simply make a copy of this default, and start
filling in your real-world data. You can even run the above template
command, adding <code>--values=/path/to/yourValues.yaml</code> before
the <code>|</code> to tell Helm to use your new file, in order to check
your work.</p>
<h2 id="components-overview">Components overview</h2>
<h3 id="nmstate-operator">nmstate operator</h3>
<p>Relevant templates:</p>
<ul>
<li><a
href="templates/nmstate-instance.yml">nmstate-instance.yaml</a></li>
<li><a
href="templates/nmstate-namespace.yaml">nmstate-namespace.yaml</a></li>
<li><a
href="templates/nmstate-operator.yaml">nmstate-operator.yaml</a></li>
<li><a
href="templates/nmstate-operatorgroup.yaml">nmstate-operatorgroup.yaml</a></li>
<li><a href="templates/nncp-bond.yaml">nncp-bond.yaml</a></li>
<li><a href="templates/nncps.yaml">nncps.yaml</a></li>
</ul>
<p>The nmstate operator is what brings in the
NodeNetworkConfigurationPolicy CRD’s , allowing us to further tweak the
network setup of the cluster.</p>
<h3 id="chrony">Chrony</h3>
<p>Relevant templates:</p>
<ul>
<li><a
href="templates/chrony-configuration.yaml">chrony-configuration.yaml</a></li>
</ul>
<h3 id="ldap">LDAP</h3>
<p>Relevant templates:</p>
<ul>
<li><a href="templates/ldap-accounts.yaml">ldap-accounts</a></li>
<li><a
href="templates/ldap-bind-secret.yaml">ldap-bind-secret.yaml</a></li>
<li><a href="templates/ocp-oauth-sec.yaml">ocp-oauth-sec.yaml</a></li>
</ul>
<h3 id="storage">Storage</h3>
<p>Relevant templates:</p>
<ul>
<li><a href="templates/ocp-trident.yaml">ocp-trident.yaml</a></li>
<li><a
href="templates/trident-machineconfig-master.yaml">trident-machineconfig-master.yaml</a></li>
<li><a
href="templates/trident-machineconfig-worker.yaml">trident-machineconfig-worker.yaml</a></li>
</ul>
<p>Most Kubernetes distributions come with the packages and utilities to
mount NFS backends installed by default, including Red Hat
OpenShift.</p>
<p>However, for NFSv3, there is no mechanism to negotiate concurrency
between the client and the server. Hence the maximum number of
client-side sunrpc slot table entries must be manually synced with
supported value on the server to ensure the best performance for the NFS
connection without the server having to decrease the window size of the
connection.</p>
<p>For ONTAP, the supported maximum number of sunrpc slot table entries
is 128 i.e. ONTAP can serve 128 concurrent NFS requests at a time.
However, by default, Red Hat CoreOS/Red Hat Enterprise Linux has maximum
of 65,536 sunrpc slot table entries per connection. We need to set this
value to 128 and this can be done using Machine Config Operator (MCO) in
OpenShift.</p>
<p>For more information see
https://docs.netapp.com/us-en/netapp-solutions/containers/rh-os-n_overview_trident.html#nfs</p>
<h3 id="other">Other</h3>
<h4 id="proxy">Proxy</h4>
<p>Relevant templates:</p>
<ul>
<li><a href="templates/custom-ca.yaml">custom-ca.yaml</a></li>
<li><a href="templates/proxy.yaml">proxy.yaml</a></li>
</ul>
<h4 id="ingress">Ingress</h4>
<p>Relevant templates:</p>
<ul>
<li><a
href="templates/ingress-certs-secret.yaml">ingress-certs-secret.yaml</a></li>
<li><a
href="templates/ingress-controller.yaml">ingress-controller.yaml</a></li>
</ul>
<h1 id="vm-migration-from-vmware-vcenter-to-openshift-virtualization">VM
Migration from VMware vCenter to OpenShift Virtualization</h1>
<p>This guide outlines the steps to migrate virtual machines (VMs) from
VMware vCenter to OpenShift Virtualization. It includes setting up
networking, managing VM configurations, executing the migration, and
troubleshooting common issues.</p>
<h2 id="pre-migration-preparation">Pre-Migration Preparation</h2>
<h3 id="access-and-permissions">1. Access and Permissions</h3>
<ul>
<li>Ensure you have the necessary access permissions to both VMware
vCenter and OpenShift Virtualization clusters.</li>
<li>Create source provider(s) for vmware and/or vcenter:
<ul>
<li>Steps for creating a provider can be found here:
https://docs.redhat.com/en/documentation/migration_toolkit_for_virtualization/2.7/html-single/installing_and_using_the_migration_toolkit_for_virtualization/index#mtv-overview-page_mtv</li>
</ul></li>
<li>Verify the following operators are properly configured in OpenShift:
<ul>
<li>Virtualization Operator
<ul>
<li>for hosting the migrated virtual machines</li>
</ul></li>
<li>Migration Toolkit for Virtualization Operator
<ul>
<li>to support a more automated migration of virtual machines off of
VMware</li>
</ul></li>
<li>Kubernetes NMState Operator
<ul>
<li>to manage the required networking configurations for the
machines</li>
</ul></li>
</ul></li>
</ul>
<h3 id="identifyprepare-target-vms">2. Identify/Prepare Target VMs</h3>
<p>Ensure the VM(s) you wish to migrate are properly identified in
VMware.</p>
<blockquote>
<p>WARNING: These VMs will need to be powered down for the migration and
remain down for testing to avoid IP conflicts.</p>
</blockquote>
<h3 id="networking-setup">3. Networking Setup</h3>
<ul>
<li>Create Bond: Create the Bond network using a Node Network
Configuration Policy (NNCP). Example:</li>
</ul>
<div class="sourceCode" id="cb9"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> nmstate.io/v1</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> NodeNetworkConfigurationPolicy</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> bond0</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">desiredState</span><span class="kw">:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">interfaces</span><span class="kw">:</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> bond0</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> bond</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">link-aggregation</span><span class="kw">:</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">mode</span><span class="kw">:</span><span class="at"> 802.3ad</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> ens2f0</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> ens2f1</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> ens3f0</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> ens3f1</span></span></code></pre></div>
<ul>
<li>Create VLANs: Create VLANs to map network traffic between VMware and
OpenShift Virtualization.
<ul>
<li>Example VLAN IDs: <code>677</code> (primary), <code>58</code> (for
public networks), 59 (for public networks). <a
href="https://github.com/cjnovak98/ocp4-disconnected-config/blob/main/Examples/node_network_config_policy.yaml">Example
NodeNetworkConfigurationPolicy</a></li>
</ul></li>
<li>Network Attachment: Apply network attachment definitions (NAD) that
point to the appropriate VLAN. For instance, the primary network for the
migrated VMs will map to VLAN 677, while public-facing VMs might use
VLAN 58.</li>
</ul>
<blockquote>
<p>NOTE: Unless communication is needed with the containers then it is
recommended to set the container network as disabled in the network
attachment definition.</p>
</blockquote>
<div class="sourceCode" id="cb10"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Example Network Attachment Definitions</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;k8s.cni.cncf.io/v1&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> NetworkAttachmentDefinition</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> bond0-bridge-vlan677 </span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">config</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;{</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;name&quot;: &quot;bond0-bridge-vlan677&quot;, </span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;type&quot;: &quot;bridge&quot;, </span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;bridge&quot;: &quot;bond0-br0&quot;, </span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;macspoofchk&quot;: false, </span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;vlan&quot;: 677</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="st">  }&#39;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;k8s.cni.cncf.io/v1&quot;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> NetworkAttachmentDefinition</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> bond0-bridge-vlan58 </span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">config</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;{</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;name&quot;: &quot;bond0-bridge-vlan58&quot;, </span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;type&quot;: &quot;bridge&quot;, </span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;bridge&quot;: &quot;bond0-br0&quot;, </span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;macspoofchk&quot;: false, </span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;vlan&quot;: 58</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="st">  }&#39;</span></span></code></pre></div>
<h2 id="migration-process">Migration Process</h2>
<h3 id="plan-setup">Plan Setup</h3>
<p>Migration plans are created in OpenShift using the Migration Toolkit.
This plan selects the targeted virtual machines and specifies the source
and destination environments.</p>
<ul>
<li>Choose Source Provider: Depending on your requirements, you can
select the following:
<ul>
<li>ESXi Host (preferred): Directly migrate VMs from an ESXi host
without going through vCenter. If you have access to the ESXi host
directly this is the preferable source as it is faster and can handle
more machines simultaneously. The limitation here is all of your
specified VMs will need to be put onto this specific ESXi host in
vCenter first or you will need to create a separate migration plan for
each source ESXi host.</li>
<li>vCenter: Migrate from the full vCenter environment, but avoid
pulling too many VMs simultaneously to prevent system crashes. When
using this plan you will want to limit the plan to a single VM.</li>
</ul></li>
<li>Create Migration Plan:
<ul>
<li>Select source provider (e.g., <code>esxi13-2</code> or
<code>vcenter</code>).</li>
<li>Enter a plan name using Kubernetes naming conventions:
<ul>
<li>name must be unique among other migration plans</li>
<li>at most 63 characters</li>
<li>only lowercase alphanumeric characters or ‘-’</li>
<li>start with alpha</li>
<li>end with alphanumeric</li>
<li>(e.g., <code>core-test-24oct-1449</code>).</li>
</ul></li>
<li>Choose target provider: OpenShift Virtualization.</li>
<li>Set up network mapping:
<ul>
<li>Map VMware networks to OpenShift VLANs (e.g., map vlan-677 to
vlan-677 in OCP).
<ul>
<li>NOTE: if the source vlan numbers don’t line up, vlan-677 is to be
used for all internal communications and should likely be used by
default. vlan 58 or 59 are considered the ‘public’ communication
network.</li>
<li>If the target vlan is not available then review the network
attachment definitions are set up properly.</li>
</ul></li>
</ul></li>
<li>Set up storage mapping:
<ul>
<li>Select OpenShift’s temporary storage (e.g., openshift-temp) and map
it to OpenShift’s CSI storage (e.g., basic-csi).</li>
</ul></li>
</ul></li>
<li>Start Migration: Click Start Migration to initiate the migration of
selected VMs.</li>
</ul>
<h3 id="vm-post-migration-configuration">VM Post-Migration
Configuration</h3>
<p>The virtio drivers that OpenShift Virtualization uses are not
supported by default for the older versions of RHEL and Windows Server.
Since OpenShift Virtualization defaults to virtio for the network and
disk interfaces you will need to update that setting post migration.
Once the migration process is complete, and the VM is created in
OpenShift (e.g., web-qa), follow these steps:</p>
<ul>
<li>Modify Network Interfaces:
<ul>
<li>Ensure the network interfaces are set to e1000e.</li>
<li>Be sure it is set to attach the VM to the correct VLAN (e.g.,
vlan-677 for internal network communication).</li>
</ul></li>
<li>Modify Disk Configuration:
<ul>
<li>Change the disk interface type from virtio to SATA</li>
</ul></li>
<li>Start the VM:
<ul>
<li>Once all configurations are verified, go to Actions → Start to power
on the VM in OpenShift Virtualization.</li>
<li>If the VM is already running you must stop it and restart it in
order for the changes to be applied.</li>
</ul></li>
</ul>
<h3 id="dealing-with-windows-specific-issues">Dealing with
Windows-Specific Issues</h3>
<p>For any Windows based VMs (e.g., Windows Server 2012), special steps
are needed:</p>
<ul>
<li>Shutdown Windows Properly in vCenter:
<ul>
<li>Always shut down the Windows VM gracefully:
<code>shutdown /s</code>.</li>
<li>Windows VMs can experience issues migrating due to hibernation or
fast boot settings. When these are enabled it may cause the file system
to be mounted as read-only which prevents the migration from taking
place. &gt; NOTE: it appears fast boot is enabled by default for Windows
Server 2012</li>
</ul></li>
</ul>
<h2 id="recommended-practices-and-considerations">Recommended Practices
and Considerations</h2>
<h3 id="vms-not-starting-after-migration">VMs Not Starting After
Migration</h3>
<p>Any VMs running an OS which is not in the list of supported guest
operating systems, or operating systems that have difficulty with the
virtio drivers may need to use these other drivers for their disk and
network interfaces:</p>
<ul>
<li><p>Disk Configuration: Ensure all disks are configured to SATA after
migration.</p></li>
<li><p>Network Configuration: Double-check that the VM is connected to
the correct VLAN and that e1000e is used for network interfaces.
Additionally, if e1000e is the interface used in the VMware environment,
then using this setting may help to ensure previous network
configurations remain on the migrated VM.</p></li>
</ul>
<h3 id="migration-plan-recommended-practices">Migration Plan Recommended
Practices</h3>
<ul>
<li><p>Avoid migrating multiple VMs simultaneously from vCenter as this
may overwhelm the system. Always perform migration of one VM at a time
when migrating from vCenter as the source provider.</p></li>
<li><p>It is also possible to throttle the number of simultaneous
migrations in the MTV configurations. This will allow you to put more
than one machine in a single migration plan (regardless of if it’s from
vCenter vs ESXi host) and not to overwhelm the source system. This can
be done by modifying the <code>controller_max_vm_inflight</code> setting
which is found in the forklift-controller CR created by the MTV
operator. <a
href="https://docs.redhat.com/en/documentation/migration_toolkit_for_virtualization/2.7/html-single/installing_and_using_the_migration_toolkit_for_virtualization/index#configuring-mtv-operator_mtv">More
info for additional configuration options</a></p></li>
</ul>
<div class="sourceCode" id="cb11"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">controller_max_vm_inflight</span><span class="kw">:</span><span class="at"> &lt;number&gt;</span><span class="co"> #defaults to 20</span></span></code></pre></div>
<h3 id="saving-and-re-importing-vms">Saving and Re-Importing VMs</h3>
<ul>
<li>Consider creating backups of VM data and configurations before
migration, especially when dealing with production VMs.</li>
<li>Use tools like <code>virtctl</code> to upload images or configure
persistent volumes. In case of failure, ensure you have a repeatable
process for re-importing the VM images.</li>
</ul>
<h3 id="migration-plan-failures">Migration Plan Failures</h3>
<ul>
<li><p>API Gateway Errors: If the migration fails due to a bad API
gateway, verify network connectivity and access permissions for the
gateway. Restarting the gateway or re-initiating the plan may resolve
the issue.</p></li>
<li><p>High RAM Usage: Monitor node resource usage during the migration
process. Nodes with high memory consumption may affect the migration
speed or cause failures.</p></li>
</ul>
<h3 id="more-information">More information:</h3>
<ul>
<li><p>More detailed information can be found in the migration toolkit
user guide:
https://docs.redhat.com/en/documentation/migration_toolkit_for_virtualization/2.7</p></li>
<li><p>More detailed information about OpenShift Virtualization in
general can be found here:
https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/virtualization/index</p></li>
</ul>
<h2 id="automation-notes">Automation Notes</h2>
<!-- TODO: update example with JT's script for this step -->
<p>Automatically update the disk and network interfaces for all virtual
machines with a script. This script: * gets the current configurations
for all vms on openshift and then loops through each to * modify the
storage and network interfaces to use SATA/e1000e to prevent any
potential virtio/storage issues for unsupported guest operating systems
* apply the updated config * start or restart the VM</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">!#/bin/bash</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set namespace and project</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="va">NAMESPACE</span><span class="op">=</span><span class="st">&quot;your-namespace&quot;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get all VirtualMachine configurations from OpenShift</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Fetching all VM configurations...&quot;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="ex">oc</span> get vm <span class="at">-n</span> <span class="st">&quot;</span><span class="va">$NAMESPACE</span><span class="st">&quot;</span> <span class="at">-o</span> name <span class="kw">|</span> <span class="cf">while</span> <span class="bu">read</span> <span class="at">-r</span> <span class="va">vm</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Processing </span><span class="va">$vm</span><span class="st">...&quot;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Export the VM&#39;s YAML config</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">oc</span> get <span class="st">&quot;</span><span class="va">$vm</span><span class="st">&quot;</span> <span class="at">-n</span> <span class="st">&quot;</span><span class="va">$NAMESPACE</span><span class="st">&quot;</span> <span class="at">-o</span> yaml <span class="op">&gt;</span> <span class="st">&quot;/tmp/</span><span class="va">${vm</span><span class="op">//</span><span class="dt">\/</span><span class="op">/</span>-<span class="va">}</span><span class="st">.yaml&quot;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the YAML file exists</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">[[</span> <span class="ot">!</span> <span class="ot">-f</span> <span class="st">&quot;/tmp/</span><span class="va">${vm</span><span class="op">//</span><span class="dt">\/</span><span class="op">/</span>-<span class="va">}</span><span class="st">.yaml&quot;</span> <span class="kw">]];</span> <span class="cf">then</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;Error: Could not fetch YAML for </span><span class="va">$vm</span><span class="st">. Skipping...&quot;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform sed replacement on disk interface type (virtio -&gt; sata)</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Updating disk interface to &#39;sata&#39;&quot;</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;/disk:/,/interface:/s/virtio/sata/g&#39;</span> <span class="st">&quot;/tmp/</span><span class="va">${vm</span><span class="op">//</span><span class="dt">\/</span><span class="op">/</span>-<span class="va">}</span><span class="st">.yaml&quot;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform sed replacement on network interface type (virtio -&gt; e1000e)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Updating network interface to &#39;e1000e&#39;&quot;</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;/networkInterfaces:/,/model:/s/virtio/e1000e/g&#39;</span> <span class="st">&quot;/tmp/</span><span class="va">${vm</span><span class="op">//</span><span class="dt">\/</span><span class="op">/</span>-<span class="va">}</span><span class="st">.yaml&quot;</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the updated YAML to OpenShift</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Applying updated configuration for </span><span class="va">$vm</span><span class="st">...&quot;</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="ex">oc</span> apply <span class="at">-f</span> <span class="st">&quot;/tmp/</span><span class="va">${vm</span><span class="op">//</span><span class="dt">\/</span><span class="op">/</span>-<span class="va">}</span><span class="st">.yaml&quot;</span> <span class="at">-n</span> <span class="st">&quot;</span><span class="va">$NAMESPACE</span><span class="st">&quot;</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the VM is running or stopped </span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="va">vm_status</span><span class="op">=</span><span class="va">$(</span><span class="ex">virtctl</span> status <span class="st">&quot;</span><span class="va">$vm</span><span class="st">&quot;</span> <span class="at">-n</span> <span class="st">&quot;</span><span class="va">$NAMESPACE</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-oP</span> <span class="st">&quot;(?&lt;=Status: )\w+&quot;</span><span class="va">)</span> </span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">[[</span> <span class="st">&quot;</span><span class="va">$vm_status</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;Running&quot;</span> <span class="kw">]];</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;VM </span><span class="va">$vm</span><span class="st"> is running. Stopping now...&quot;</span> </span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        <span class="ex">virtctl</span> stop <span class="st">&quot;</span><span class="va">$vm</span><span class="st">&quot;</span> </span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="kw">[[</span> <span class="st">&quot;</span><span class="va">$vm_status</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;Stopped&quot;</span> <span class="kw">]];</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;VM </span><span class="va">$vm</span><span class="st"> is already stopped.&quot;</span> </span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> </span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;VM </span><span class="va">$vm</span><span class="st"> is in an unknown state: </span><span class="va">$vm_status</span><span class="st">. Skipping restart...&quot;</span> </span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span> </span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start the VM </span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="ex">virtctl</span> start <span class="st">&quot;</span><span class="va">$vm</span><span class="st">&quot;</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up the temporary file</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span> <span class="at">-f</span> <span class="st">&quot;/tmp/</span><span class="va">${vm</span><span class="op">//</span><span class="dt">\/</span><span class="op">/</span>-<span class="va">}</span><span class="st">.yaml&quot;</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Finished processing </span><span class="va">$vm</span><span class="st">.&quot;</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;All VM configurations updated successfully!&quot;</span></span></code></pre></div>
</body>
</html>
