---
- name: Check if ocp4.disconnected collection is installed
  ansible.builtin.command: ansible-galaxy collection list ocp4.disconnected
  register: collection_install
  changed_when: Â "'unable to find ocp4.disconnected in collection paths' in collection_install.stderr"
  failed_when: false

- name: Test if connected to the internet
  ansible.builtin.uri:
    url: https://www.redhat.com
    method: GET
    status_code: 200
    validate_certs: false
  register: internet
  until: internet.status == 200
  retries: 2
  delay: 1
  failed_when: false
  changed_when: internet.status == 200
  when: collection_install.rc == 5 and update_collection | bool

- name: Install ansible collections from local media
  ansible.builtin.command:
    cmd: "ansible-galaxy collection install -r requirements.yml"
  args:
    chdir: "{{ common_openshift_download_dir }}/collections"
  when: collection_install is changed and internet is not changed
  register: collection_installed

- name: Install ansible collection from the internet
  ansible.builtin.command:
    cmd: ansible-galaxy collection install git+https://github.com/cjnovak98/ocp4-disconnected-collection.git -U
  when: collection_install.rc == 5 and update_collection | bool and collection_installed is not changed
